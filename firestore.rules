rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Helper function to check if user is admin
    function isAdmin() {
      return request.auth != null && 
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
    
    // Check if requesting user is admin (with existence check)
    function isAdminSafe() {
      return request.auth != null &&
             exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    // Helper function to check if email is verified (more lenient)
    function isEmailVerified() {
      return request.auth != null && 
             (request.auth.token.email_verified == true || 
              !('email_verified' in request.auth.token));
    }
    
    // Helper to check if user is authenticated (allow both verified and unverified for now)
    function isAuthenticated() {
      return request.auth != null;
    }

    // Helper function to validate string length
    function isValidString(value, minLen, maxLen) {
      return value is string && value.size() >= minLen && value.size() <= maxLen;
    }

    // Helper function to validate number range
    function isValidNumber(value, min, max) {
      return value is number && value >= min && value <= max;
    }

    // ðŸ‘¤ USERS COLLECTION
    match /users/{userId} {
      // Allow anyone (including guests) to read for farmer map and profiles
      allow read: if true;
      
      // Users can create their own profile
      allow create: if request.auth != null 
        && request.auth.uid == userId;
      
      // ADMINS: Allow all operations (read, create, update, delete)
      allow read, write: if isAdminSafe();
      
      // Regular users can update their own profile (but NOT role or email fields)
      allow update: if request.auth != null 
        && request.auth.uid == userId
        && !request.resource.data.diff(resource.data).affectedKeys().hasAny(['role', 'email']);
    }

    // ðŸ›’ PRODUCTS COLLECTION
    match /products/{productId} {
      // Admins can do everything
      allow read, write: if isAdminSafe();
      
      // Allow ANYONE (including guests) to read products for browsing
      allow read: if true;
      
      // Authenticated farmers can create products (simplified validation)
      allow create: if request.auth != null
        && request.resource.data.farmerId == request.auth.uid;
      
      // Farmer can update their products, or any user can update quantity/stock
      allow update: if request.auth != null && (
        resource.data.farmerId == request.auth.uid || 
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(["quantity"]) ||
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(["stock"]) ||
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(["quantity", "stock"])
      );
      
      // Product owner can delete
      allow delete: if request.auth != null && resource.data.farmerId == request.auth.uid;
    }

    // ðŸ“¦ ORDERS COLLECTION
    match /orders/{orderId} {
      // Admins can do everything
      allow read, write: if isAdminSafe();

      // Allow buyer to read their own orders
      allow read: if request.auth != null && resource.data.buyerId == request.auth.uid;

      // Allow farmer to read orders that belong to them
      allow read: if request.auth != null && resource.data.farmerId == request.auth.uid;

      // Authenticated users can create orders
      allow create: if request.auth != null
        && request.resource.data.buyerId == request.auth.uid;

      // Allow farmer to update their orders
      allow update: if request.auth != null
        && resource.data.farmerId == request.auth.uid;

      // Allow buyer to update their own orders
      allow update: if request.auth != null
        && resource.data.buyerId == request.auth.uid;
    }

    // ðŸ›’ CART COLLECTION
    match /cart/{cartId} {
      // Admins can do everything
      allow read, write: if isAdminSafe();
      
      // Allow authenticated users to manage their cart
      allow read, update: if request.auth != null && resource.data.userId == request.auth.uid;
      
      allow create: if request.auth != null
        && request.resource.data.userId == request.auth.uid;
      
      allow delete: if request.auth != null && resource.data.userId == request.auth.uid;
    }

    // ðŸ’¬ REVIEWS COLLECTION
    match /reviews/{reviewId} {
      allow read: if request.auth != null;
      
      allow create: if request.auth != null
        && request.resource.data.userId == request.auth.uid;
      
      allow update, delete: if request.auth != null && resource.data.userId == request.auth.uid;
    }

    // â­ RATINGS COLLECTION
    match /ratings/{ratingId} {
      // Admins can do everything
      allow read, write: if isAdminSafe();
      
      allow read: if request.auth != null;
      
      allow create: if request.auth != null
        && request.resource.data.userId == request.auth.uid;
      
      allow update: if request.auth != null && resource.data.userId == request.auth.uid;
      allow delete: if request.auth != null && resource.data.userId == request.auth.uid;
    }

    // Remove duplicate ratings match
    match /farmers/{farmerId}/ratings/{ratingId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated() && request.auth.uid == request.resource.data.userId;
    }

    // ðŸŒ± COMMUNITY POSTS COLLECTION
    match /community_posts/{postId} {
      // Anyone (including guests) can read posts
      allow read: if true;
      
      // Authenticated users can create posts
      allow create: if request.auth != null
        && request.resource.data.authorId == request.auth.uid;
      
      // Authors can update their own posts, or anyone can update likes/likedBy/commentCount
      allow update: if request.auth != null && (
        resource.data.authorId == request.auth.uid ||
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['likes', 'likedBy', 'commentCount'])
      );
      
      // Authors can delete their own posts
      allow delete: if request.auth != null && resource.data.authorId == request.auth.uid;
    }

    // ðŸ’¬ COMMUNITY COMMENTS COLLECTION
    match /community_comments/{commentId} {
      // Anyone (including guests) can read comments
      allow read: if true;
      
      // Authenticated users can create comments
      allow create: if request.auth != null
        && request.resource.data.authorId == request.auth.uid;
      
      // Authors can update their own comments
      allow update: if request.auth != null && resource.data.authorId == request.auth.uid;
      
      // Authors can delete their own comments
      allow delete: if request.auth != null && resource.data.authorId == request.auth.uid;
    }

    // ðŸ’° WALLETS COLLECTION
    match /wallets/{userId} {
      // Users can read their own wallet
      allow read: if request.auth != null && request.auth.uid == userId;
      
      // Authenticated users can create their own wallet
      allow create: if request.auth != null
        && request.auth.uid == userId
        && request.resource.data.userId == userId;
      
      // Users can update their own wallet
      allow update: if request.auth != null
        && request.auth.uid == userId;
      
      // Admins can read and update any wallet
      allow read, update: if isAdmin();
    }

    // ðŸ’³ WALLET TRANSACTIONS COLLECTION
    match /wallet_transactions/{transactionId} {
      // Users can read their own transactions
      allow read: if request.auth != null && resource.data.userId == request.auth.uid;
      
      // Authenticated users can create transactions
      allow create: if request.auth != null
        && request.resource.data.userId == request.auth.uid;
      
      // Admins can read all transactions
      allow read: if isAdmin();
    }
  }
}